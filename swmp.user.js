// ==UserScript==
// @name     4chan \ IB Media Player
// @description		Windowed and configurable media player for 4chan and other imageboards running vichan, tinyib, wakaba, lynxchan, and jschan.
// @author https://github.com/LabMember-001
// @version  1.0
// @grant    none

// @run-at      document-end

// @match https://*.(4chan|4channel).org/*
// @match https://*.(smuglo.li|smugloli.net)/*
// @match https://*.kissu.moe/*
// @match https://*.2kind.moe/*
// @match https://*.1chan.net/*
// @match https://*.otterchat.net/*
// @match https://*.fatchan.org/*
// @match https://*.7chan.org/*
// @match https://*.420chan.org/*
// @match https://*.anon.cafe/*

// @match https://*.archived.moe/*
// @match https://*.4plebs.org/*
// @match https://*.warosu.org/*

// @match https://*/*

// ==/UserScript==


// @match https://*/*
// Most of the sites above are purely to test scripts.

console.log('Loading IB Media Player.');

/* Repository:	 																						*/
/* https://github.com/LabMember-001/Simple-Web-Media-Player */
/* https://okabe.moe/projects/simplewebmediaplayer 					*/
/*																													*/
/*                                              						*/
/* 																													*/

/* 		== BOARD SUPPORT == 
// Script will alter behavior on different imageboard backends
// When adding custom board scripts, alter board behavior on bottom of the script. You'll need some knowledge on JS.
// In most cases, simply adding an @match to the top of this script to turn it on for that domain will work 
// as it captures all link presses and checks for webm.
// If you want more compatability, check the issue tracker for existing requests and if there are none, you may request help.
*/

/* 		== SCRIPT CONFIGURATION ==
// To define a board as a precoded backend type (vichan, tinyib, lynxchan, etc) simply
// add a regex for that domain in the swmpBoards category below these comments.
*/

/* 		== TO DO ==
//
// High priority
// - Resizing
//
// Medium Priority
// - Loading poster for large files
// - Make window move stop if you release mouseup outside of the screen.
// - Automatic backend script detection.
//
// Low Priority
// - Title length
// - Fix support for archived.moe redirection urls.
// - Fix the god damn & from player.php in vichan title.
// - Youtube support
// - Fix titles on some backends. (Mostly just vichan+4chan taking original filename right now).
*/

/* 		== Current Script Support ==
// Yotsuba (4chan)
// Tinyboard/Vichan/Infinity
// Fuuka
// TinyIB
// Wakaba
// FoolFuuka (Not archived.moe's redirects, but 4plebs is fine).
// Kusaba
*/

/* 	== Script Specific Bugs == 
// - Vichan shows original title when clicked on video thumb, but not link.
// - Doesnt grab titles on Fuuka, TinyIB, Wakaba, FoolFuuka
//
*/

/*
// 		== Missing Script Support ==
// Some Kusaba sites have issues loading video when clicked on thumbnail. Links typically work. 7chan is fine.
// Phutaba has a slight bug with videos which shows file information when hovering over player depending on which link you click.
// Some of the bigger Lynxchan sites are very modified and have no thumbnail click support.
// jschan and vichan will not properly work if not added to the board specific types. Should be fixable for me later.
// InfinityNext does not work. Don't care.
*/

 // Get domain
var currentUrl = window.location.href;

	// Board Types - probably temporary.
var swmpBoards = {
 	fourchan: // For title support, otherwise works well without adding here.
  		['https:\/\/*..*(4chan|4channel).org\/*'], 
  vichan:  // For Title and thumbnail click support. Not great without due to thumbnails.
  		['https:\/\/*..*(smuglo.li|smugloli.net)\/*', 
       'https:\/\/*..*2kind.moe\/*',
       'https:\/\/*..*kissu.moe\/*'], // Also works on new UI (lolnoty) as long as it's in here.
  tinyib: // Title support not written, otherwise works well without adding here.
  		['https:\/\/*..*1chan.net\/*'], 
  wakaba: // Title support not written, otherwise works well without adding here.
  		['https:\/\/*..*otterchat.net\/*'], 
  lynxchan: // Title support not written, otherwise works well without adding here.
  		['https:\/\/*..*anon.cafe\/*'], 
  jschan: // Title support not written. Jschan installations *must* be added here to work properly.
  		['https:\/\/*..*fatchan.org\/*'] 
};

	// regex to check the backend script of current domain
var backendScript = [];
Object.keys(swmpBoards).forEach(script => {
  swmpBoards[script].forEach(regex => {
    if (currentUrl.match(regex)) {
      backendScript = script;
    }
  });
});

console.log(backendScript);


	// This configuration variable can be overwritten wherever you want later 
	// on as you wish or add your own site variables for user configuration.
var swmpConfig = {
	autoplay: 'true', // Autoplay media when launched by SWMP.
	loop: 'true', // Loop media when launched by SWMP.
	positionTop: '100',
  positionOffset: '100',
  positionSide: 'right',
	volume: 60,
	theme: 'default', //Default theme
	themes: //All themes
		[
			['default', 'MPC Light'],
			['dark', 'MPC Dark'],
			['kurisu', 'Kurisumasu'],
      ['bluemoon', 'Blue Moon']
		],
	files: 'avi|mpeg|mpg|ogv|mp4|webm|flv|wav|mp3|m4a|mp2|ogg|flac',
  allowMultiple: 'false'
};

if(null==localStorage.swmpVolume?localStorage.swmpVolume=swmpConfig.volume:swmpConfig.volume=localStorage.swmpVolume,null==localStorage.swmpTheme?localStorage.swmpTheme="default":swmpConfig.theme=localStorage.swmpTheme,null==localStorage.swmpAutoplay?localStorage.swmpAutoplay="true":swmpConfig.autoplay=localStorage.swmpAutoplay,null==localStorage.swmpLoop?localStorage.swmpLoop="true":swmpConfig.loop=localStorage.swmpLoop,null==localStorage.swmpAllowMultiple?localStorage.swmpAllowMultiple="false":swmpConfig.allowMultiple=localStorage.swmpAllowMultiple,!document.getElementById("swmp-stylesheet")){var swmpStyle=document.createElement("style");swmpStyle.innerHTML=".swmp *{background:0 0;border:0;outline:0;margin:0;padding:0;line-height:1;height:unset;width:unset;font-family:-apple-system,BlinkMacSystemFont,URW Gothic,MS PGothic,Helvetica,sans-serif;font-size:11pt;text-indent:4px;letter-spacing:1px;color:var(--swmp-text-color)}div.swmp{--swmp-background:#e6e6e6;--swmp-container-border:#000;--swmp-player-container-background:#000;--swmp-controls-background:var(--swmp-background);--swmp-text-color:#000;--swmp-button-background:var(--swmp-background);--swmp-button-mask-color:#000;--swmp-seek-height:30px;--swmp-seek-offset:10px;--swmp-seek-background:var(--swmp-controls-background);--swmp-seek-progress-color:lightgrey;--swmp-seek-border-left:darkgray;--swmp-seek-border-top:darkgray;--swmp-seek-border-right:#fff;--swmp-seek-border-bottom:#fff;--swmp-range-thumb-color:var(--swmp-controls-background);--swmp-range-thumb-border-left:#fff;--swmp-range-thumb-border-top:#fff;--swmp-range-thumb-border-right:#000;--swmp-range-thumb-border-bottom:#000;--swmp-btn-border-left:#fff;--swmp-btn-border-top:#fff;--swmp-btn-border-right:#000;--swmp-btn-border-bottom:#000;--swmp-btn-border-left-active:#000;--swmp-btn-border-top-active:#000;--swmp-btn-border-right-active:#fff;--swmp-btn-border-bottom-active:#fff}div.swmp.swmp-theme-dark,div.swmp.swmp-theme-dark *{--swmp-background:#333;--swmp-container-border:#000;--swmp-controls-background:var(--swmp-background);--swmp-text-color:#888;--swmp-button-background:var(--swmp-background);--swmp-button-mask-color:#888;--swmp-seek-height:30px;--swmp-seek-offset:10px;--swmp-seek-progress-color:#555;--swmp-seek-border-left:#1a1a1a;--swmp-seek-border-top:#1a1a1a;--swmp-seek-border-right:#464646;--swmp-seek-border-bottom:#464646;--swmp-range-thumb-color:var(--swmp-background);--swmp-range-thumb-border-left:#777;--swmp-range-thumb-border-top:#777;--swmp-range-thumb-border-right:#000;--swmp-range-thumb-border-bottom:#000;--swmp-btn-border-left:#777;--swmp-btn-border-top:#777;--swmp-btn-border-right:#000;--swmp-btn-border-bottom:#000;--swmp-btn-border-left-active:#000;--swmp-btn-border-top-active:#000;--swmp-btn-border-right-active:#777;--swmp-btn-border-bottom-active:#777}div.swmp.swmp-theme-kurisu,div.swmp.swmp-theme-kurisu *{--swmp-background:#a44242;--swmp-text-color:#fff;--swmp-button-mask-color:#fff}div.swmp.swmp-theme-bluemoon,div.swmp.swmp-theme-bluemoon *{--swmp-background:#272d37;--swmp-text-color:#eee;--swmp-button-mask-color:#d3d3d3;--swmp-controls-background:#49525D;--swmp-btn-border-left:#DDDDDD;--swmp-btn-border-top:#DDDDDD;--swmp-range-thumb-border-top:#ddd;--swmp-range-thumb-color:#272d37}div.swmp.swmp-container{position:relative;display:inline-flex;flex-direction:column;padding:2px;background:var(--swmp-background);font-family:-apple-system,BlinkMacSystemFont,URW Gothic,MS PGothic,Helvetica,sans-serif;font-size:11pt;text-indent:4px;letter-spacing:1px;color:var(--swmp-text-color);border:1px solid var(--swmp-container-border);line-height:1;z-index:1;overflow:hidden;min-width:320px;width:auto;outline:0}div.swmp.swmp-window.swmp-window-container{display:flex;justify-content:space-between;padding-bottom:2px}div.swmp.swmp-fullscreen div.swmp-settings.swmp-settings-container,div.swmp.swmp-fullscreen div.swmp-window.swmp-window-container{display:none}div.swmp.swmp-minimized video{display:none}div.swmp.swmp-fullscreen video{display:block}span.swmp.swmp-window.swmp-window-titlebar{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;-webkit-user-select:none;user-select:none;position:relative;margin:auto;cursor:move;width:100%;text-align:center;display:block}span.swmp.swmp-window.swmp-window-title{display:block;max-width:260px;text-overflow:ellipsis;overflow:hidden;margin:auto;line-height:1.5;margin-bottom:-2px}span.swmp.swmp-window.swmp-window-buttons-contain{display:flex;flex:0 1 auto}div.swmp .swmp-player-container{display:flex;height:100%;background:var(--swmp-player-container-background)}div.swmp.swmp-container.swmp-audio{display:block}div.swmp.swmp-container.swmp-fullscreen{background:#000;position:unset!important;width:100%;height:auto}div.swmp.swmp-container.swmp-fullscreen video{width:100%;height:auto;max-width:100%;max-height:100%}div.swmp video{max-width:500px;max-height:500px;width:auto;height:auto;margin:auto}div.swmp audio{min-width:320px;min-height:40px}div.swmp.swmp-controls{bottom:0;left:0;background:var(--swmp-controls-background);width:100%;display:flex;flex-direction:column}div.swmp.swmp-fullscreen div.swmp.swmp-controls{position:absolute;opacity:0;transition:opacity .5s 1s ease-out}div.swmp.swmp-fullscreen div.swmp.swmp-controls:hover{opacity:1;position:absolute;transition:none}div.swmp.swmp-controls span.swmp-seek-container{display:flex;width:calc(100% - 6px);height:var(--swmp-seek-height);margin:auto}div.swmp.swmp-controls span.swmp-seek-container input.swmp.swmp-seeker{width:calc(100% - var(--swmp-seek-offset));left:calc(var(--swmp-seek-offset)/ 2);-webkit-appearance:none;background:#0000;padding:0;margin:0;height:var(--swmp-seek-height);position:absolute;z-index:1;cursor:pointer;-webkit-margin-top:-14px}span.swmp input[type=range]::-webkit-slider-runnable-track{width:100%;height:6px;cursor:pointer;background:#0000;border-radius:0;border:1px solid #000;border-left-color:var(--swmp-seek-border-left);border-top-color:var(--swmp-seek-border-top);border-right-color:var(--swmp-seek-border-right);border-bottom-color:var(--swmp-seek-border-bottom)}span.swmp input[type=range]::-moz-range-track{width:100%;height:6px;cursor:pointer;background:#0000;border-radius:0;border:1px solid #000;border-left-color:var(--swmp-seek-border-left);border-top-color:var(--swmp-seek-border-top);border-right-color:var(--swmp-seek-border-right);border-bottom-color:var(--swmp-seek-border-bottom)}span.swmp progress::-webkit-progress-bar{background:#0000}span.swmp progress::-webkit-progress-value{background:var(--swmp-seek-progress-color)}span.swmp progress::-moz-progress-bar{background:var(--swmp-seek-progress-color)}span.swmp input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;border:4px solid var(--swmp-range-thumb-color);height:8px;width:2px;border-radius:0;padding:4px 3px;background:#0000;background:linear-gradient(180deg,var(--swmp-seek-border-top) 10%,var(--swmp-seek-background) 10%,var(--swmp-seek-background) 90%,var(--swmp-seek-border-bottom) 90%);cursor:pointer;margin-top:-6px;box-shadow:1px 1px 0 0 var(--swmp-range-thumb-border-bottom),-1px -1px 0 0 var(--swmp-range-thumb-border-top)}span.swmp input[type=range]::-moz-range-thumb{appearance:none;border:4px solid var(--swmp-range-thumb-color);height:8px;width:6px;border-radius:0;background:linear-gradient(180deg,var(--swmp-seek-border-top) 10%,var(--swmp-seek-background) 10%,var(--swmp-seek-background) 90%,var(--swmp-seek-border-bottom) 90%);cursor:pointer;box-shadow:1px 1px 0 0 var(--swmp-range-thumb-border-bottom),-1px -1px 0 0 var(--swmp-range-thumb-border-top)}span.swmp input[type=range]::-webkit-range-progress{height:6px;background-color:#0000}span.swmp input[type=range]::-moz-range-progress{height:6px;background-color:#0000}span.swmp input[type=range]{background:0 0;border:0;outline:0}span.swmp progress.swmp-volume{width:50px;position:absolute;height:6px;right:8px;border:none;bottom:7px;z-index:0;background:var(--swmp-seek-background)}span.swmp input.swmp-volume[type=range]{-webkit-appearance:none;background:#0000;padding:0;margin-left:2px;cursor:pointer;position:relative}span.swmp input.swmp-volume[type=range]::-webkit-slider-thumb{padding:4px 2px;width:2px}span.swmp input.swmp-volume[type=range]::-moz-range-thumb{padding:0 1px;width:1px}div.swmp.swmp-controls span.swmp-seek-container progress.swmp-progress{width:100%;height:6px;z-index:0;position:relative;background:var(--swmp-seek-background);bottom:-12px;border:none}span.swmp.swmp-row-bottom{display:flex;flex-direction:row;height:20px;margin-bottom:2px}div.swmp.swmp-fullscreen span.swmp.swmp-row-bottom{padding-bottom:5px}span.swmp.swmp-buttons-container{height:100%}select.swmp.swmp-selector{-webkit-appearance:none;appearance:none;background:var(--swmp-button-background);border:1px solid var(--swmp-text-color);color:var(--swmp-text-color);outline:0;border-radius:0;width:85px;overflow:hidden;text-overflow:ellipsis}label.swmp.swmp-settings{display:inline-flex;flex-direction:row-reverse}input.swmp.swmp-settings{margin:-2px 0 0 4px;border:1px solid var(--swmp-text-color);appearance:none;-webkit-appearance:none;outline:0;width:14px;height:14px;background:var(--swmp-controls-background)}input.swmp.swmp-settings:checked{outline:5px inset var(--swmp-text-color);outline-offset:-8px}button.swmp.swmp-button{min-width:26px;height:100%;padding:0 4px;display:inline-block;cursor:pointer;margin-left:2px;margin-right:2px;color:var(--swmp-button-mask-color);background:var(--swmp-button-background);border:1px solid;border-bottom-color:var(--swmp-btn-border-bottom);border-right-color:var(--swmp-btn-border-right);border-top-color:var(--swmp-btn-border-top);border-left-color:var(--swmp-btn-border-left);filter:unset}button.swmp.swmp-button span{display:block;width:16px;height:16px;image-rendering:pixelated;background-repeat:no-repeat;background-color:var(--swmp-button-mask-color);-webkit-mask-image:var(--image);mask-image:var(--image);-webkit-mask-size:16px;mask-size:16px;-webkit-mask-repeat:no-repeat;mask-repeat:no-repeat}span.swmp.swmp-window button{height:20px;min-width:22px;width:22px}button.swmp.swmp-button.swmp-window-minimize span{--image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAARElEQVRYR+3V0Q0AMAQFQPYfuv7apAPg4yzguQQZw5XD/UMAAgQIECCwTuA0fcc7+C8gAIFxgaYleG3W3QECBAgQaBcokVQGIRA6KiEAAAAASUVORK5CYII=');margin-top:2px;-webkit-mask-size:12px;mask-size:12px}button.swmp.swmp-button.swmp-window-close span{--image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9UlEQVRoge2Y2woCMRBD5699dB79a7ViQfDWaZNMFybQR5NzVndhNatUKpUjxe/nctT+Vn59HsYItf+1nDFC7f9Ujhyh9v8qR4xQ+0fKV0bY/XYKDERHIvDtnGcEWBIyeIaEHB4pkQaPkEiHnwXxyc9QE/0mtrjyCgkZfA9SQg7fg5BIg+9ZkUiH75mR2Aa+xS0uwHyzC8Vt/ieULuG2fhOnSfgA3LYSDoBOk2DAyySi8O1RyXyzo8P3pEuswKdLIODTJJDwcgkGvFQiMhKBV/UPj0yXC/r/jiyXC/q/jsDKBf1vI/ByQf8jbtz/bdj9lUqlAs4N+1iFrUSwCpcAAAAASUVORK5CYII=');margin-top:2px;-webkit-mask-size:12px;mask-size:12px}button.swmp.swmp-button.swmp-playbutton span{--image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAA8klEQVRoQ+3aMQ6DMAyF4XDycjCGVmrPBRmapVLkJLafn1GRMiHB/+EpEVtJfm3J+8vtAO86kb2uI8tkfidwfsM/WSA9QBsAPUQC0ENGAbSQWQAdZBVAA9ECwiFWgDCINQAO8QLAIN4AdwgK4AZBA8whUQAzSDRADWEBLEPYANMQVsAwhB0gQrIAupA/AHR60d2bs09APFRgBYjhbfJsgOFwNsB0OAtgOTwaoA6PApiFowHm4SiAW7g3wD3cCwALtwbAw60AYeFaQHj4KoAmfBZAFz4KoA2XAPThPcCz3njU9QJtFdWvud2vBuovgn5A+glcJSF8MQrukbIAAAAASUVORK5CYII=')}button.swmp.swmp-button.swmp-playbutton.swmp-playing span{--image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAAtUlEQVRoQ+2Y2w6AIAxD5f8/2kuCRgiJbdjDMMfnxUE5o9WyLf6Uxde//W4D+8SJuGKE9OqbhrxUFCGkFxt4qQ1CInpX2SMWCIGQwc1ILBACIRBqFQixd1HUkF4MMUMs8taVESVGupFGDZpACIROBTCy5tOsMhGiijiMIb2IEkQJkTeihCAUUUIQ6S4hShAliBKVAZwYJzbuTn7ufoiFExs04cRpndg4xRyl7uDlWPWE+aTbwAFy3FQxPpmarQAAAABJRU5ErkJggg==')}button.swmp.swmp-button.swmp-stopbutton span{--image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAUUlEQVRYR+3Xuw0AIAwD0WQC2H9LJuDXICFqm+KywEWvc4b50tyP7x7oIpE6O221bgEeQAABBBBAAAEEEEAAAQTsAkW0jPYqei0jUf9k7ON0AGFsNSFlb3+JAAAAAElFTkSuQmCC')}.swmp.swmp-timer-container,button.swmp.swmp-button.swmp-fullscreen{margin-left:auto}button.swmp.swmp-button.swmp-fullscreen span{--image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAP0lEQVQ4T2NkoBAwQvX/x2EOQXmCCghZgG4AjE/IYzAXMw4jAwj5Gac8sYFG0AB4qBLplOEYCwOfF4gMfExlADQ3GBE+X9RsAAAAAElFTkSuQmCC')}button.swmp.swmp-button.swmp-volume span{--image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwBAMAAAClLOS0AAAAG1BMVEVHcEwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABp4cHsAAAACHRSTlMA1WZ/JZz0Rme5O54AAACGSURBVDjL5ZIxCoAwDEWjVXDs6OjUWXDxRl6hqyL2H9uqKKL5oKtmzIOXNvkiP6qc9LOSAAciAoiIAAcdRNEGmrtoBQb1TbSCFt3eK3CUSAr0KliUlQbEA1YFCTCqID47qMAAwztAVXS4x2RfffC8kusSw7O100Px0/Iw0PjwwPGI0lB/s2bRbW7duVgj2wAAAABJRU5ErkJggg==')}button.swmp.swmp-button.swmp-volume.swmp-min span{--image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAQAAAD9CzEMAAAAd0lEQVR42u2Xuw2AMAwFr41YhKmyVyp2YhZ6pwEJqJDgmRTv3PukV/gDxpjBKDRl+5mV0LWvbIRKUGjEXrJoZIIjGongHI1AcI3mc8E9mpeCeFwWWGCBBTqBfNj9MK4TFk7CykxZ+glnS8LhlXI6Akws/gCMGZAO8wpmVouK9vcAAAAASUVORK5CYII=')}button.swmp.swmp-button.swmp-volume.swmp-max span{--image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwBAMAAAClLOS0AAAAD1BMVEVHcEwAAAAAAAAAAAAAAADTrAj/AAAABXRSTlMA/4hD1KmiQHMAAACwSURBVDjL1ZPBDYMwDEV/nQzAIwwAVQdoNoD9l+qhgAyKW/VGfbHkp/wk9rf0//EI6sZ8Kqx5oj/U07IdgKcHlXfOcNAyVpCA4oU2oAqDF9pB9pcYK7hLAkYnBJKMUZqgc0IgaaJIFYp0Yw/JYJAy9CegBUZZA1SYlWA4gwxdExgUCWiA/mfQlgovj56bog/6loRN/Nz2w6CSG1Q82tgMoX1iw8UWDU0dr8HXxblwvAAGdxy1HX87LAAAAABJRU5ErkJggg==')}button.swmp.swmp-button.swmp-volume.swmp-mute span{--image:url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwBAMAAAClLOS0AAAAHlBMVEUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAC3KG9qAAAACnRSTlMACZko0v9e9AufnFf4OQAAAJdJREFUeJzlkrsNgDAMRCMhL8BO6WluBmZha2LZDvmdRA1uUHi+S/xJ6Uexk/9bJuAEMcIabBmQQNLknFBw2KERFyMFcEEFalROMAlCaUYFWKoLBDU81wUdkCobgGbHDT0Q/06gSOJJA3hqeKmgd7BX0TpY5V2v2ibO3bW2L+YRg5on6KOtRT9AzdIy2PrwheMrmi4GPhk3sCZY/9usUnQAAAAASUVORK5CYII=')}span.swmp.swmp-volume-container{display:flex;width:60px;height:100%;position:relative}span.swmp.swmp-volume-container input.swmp.swmp-volume.swmp-range{width:50px;vertical-align:top;position:relative}button.swmp.swmp-button:active{border-bottom-color:var(--swmp-btn-border-bottom-active);border-right-color:var(--swmp-btn-border-right-active);border-top-color:var(--swmp-btn-border-top-active);border-left-color:var(--swmp-btn-border-left-active)}span.swmp.swmp-timer-container{display:inline-table;margin-right:5px;cursor:default}span.swmp.swmp-timer-container span.swmp.swmp-time{display:table-cell;vertical-align:bottom}#quote-preview{z-index:1}",document.querySelector("head").appendChild(swmpStyle)}class swmp{constructor(e){if(this.name="Simple Web Media Player",null==e.id?this.id=this.uuid():this.id=e.id,this.type=e.type,this.mime=e.mime,this.url=e.url,this.poster=e.poster,this.autoplay=e.autoplay,this.loop=e.loop,this.windowed=e.windowed,this.defaultVolume=parseInt(swmpConfig.volume),null==this.url)return console.log("No media given"),!1;if(null==e.title?this.title=this.getFileName(e.url):this.title=e.title,0==this.checkURL(this.url))return!1;if(this.container=document.createElement("div"),this.container.setAttribute("class","swmp swmp-container"),this.container.setAttribute("id",this.id),this.container.setAttribute("tabindex","0"),"video"==this.type)this.container.classList.add("video"),this.player=document.createElement("video"),this.player.setAttribute("class","swmp swmp-video swmp-player"),0!=this.poster&&null!=this.poster&&this.player.setAttribute("poster",this.poster);else{if("audio"!=this.type)return console.log(`SWMP Error: invalid type of ${this.type}.`),!1;this.container.classList.add("audio"),this.player=document.createElement("audio"),this.player.setAttribute("class","swmp swmp-audio swmp-player")}if(null!=this.mime&&""==this.player.canPlayType(this.mime))return this.closeError=document.createElement("span"),this.closeError.innerHTML=`Your browser can't play this format: ${this.mime}`,this.container.addEventListener("click",(e=>{this.container.remove()})),this.container.appendChild(this.closeError),!1;null!=swmpConfig.theme&&this.container.classList.add(`swmp-theme-${swmpConfig.theme}`),0!=this.windowed&&(this.windowContainer=document.createElement("div"),this.windowContainer.setAttribute("class","swmp swmp-window swmp-window-container"),this.container.appendChild(this.windowContainer),this.windowTitlebar=document.createElement("span"),this.windowTitlebar.setAttribute("class","swmp swmp-window swmp-window-titlebar"),null!=this.title?this.windowTitlebar.innerHTML=`<span class="swmp swmp-window swmp-window-title">${this.title}</span>`:this.windowTitlebar.innerHTML=`<span class="swmp swmp-window swmp-window-title">${this.url}</span>`,this.windowContainer.appendChild(this.windowTitlebar),this.windowButtonsContain=document.createElement("span"),this.windowButtonsContain.setAttribute("class","swmp swmp-window swmp-window-buttons-contain"),this.windowContainer.appendChild(this.windowButtonsContain),"video"==this.type&&(this.windowMinimize=document.createElement("button"),this.windowMinimize.setAttribute("class","swmp swmp-button swmp-window-minimize"),this.windowMinimize.innerHTML="<span></span>",this.windowMinimize.addEventListener("click",(e=>{e.preventDefault(),this.container.classList.contains("swmp-minimized")?this.container.classList.remove("swmp-minimized"):this.container.classList.add("swmp-minimized")})),this.windowButtonsContain.appendChild(this.windowMinimize)),this.windowClose=document.createElement("button"),this.windowClose.setAttribute("class","swmp swmp-button swmp-window-close"),this.windowClose.innerHTML="<span></span>",this.windowClose.addEventListener("click",(e=>{e.preventDefault(),this.container.remove()})),this.windowButtonsContain.appendChild(this.windowClose),this.makeDraggable(this.container),this.windowTitlebar.addEventListener("contextmenu",(function(e){e.preventDefault()}),!1),this.windowTitlebar.addEventListener("mousedown",(e=>{if(e.preventDefault(),3===e.which)this.openSettings()}))),this.player.setAttribute("preload","metadata"),this.playerContainer=document.createElement("div"),this.playerContainer.setAttribute("class","swmp-player-container"),this.container.appendChild(this.playerContainer),this.playerContainer.appendChild(this.player),this.source=document.createElement("source"),this.source.setAttribute("src",this.url),null!=this.mime&&this.source.setAttribute("type",this.mime),this.player.appendChild(this.source),1!=swmpConfig.autoplay&&"true"!=swmpConfig.autoplay||0==this.autoplay||this.player.setAttribute("autoplay",!0),1!=swmpConfig.loop&&"true"!=swmpConfig.loop||0==this.loop||this.player.setAttribute("loop",!0),this.controls=document.createElement("div"),this.controls.setAttribute("class","swmp swmp-controls"),this.container.appendChild(this.controls),this.controls.addEventListener("contextmenu",(function(e){e.preventDefault()}),!1),this.controls.addEventListener("mousedown",(e=>{if(3===e.which)this.openSettings()})),this.seekContain=document.createElement("span"),this.seekContain.setAttribute("class","swmp swmp-seek-container"),this.controls.appendChild(this.seekContain),this.progress=document.createElement("progress"),this.progress.setAttribute("value","0"),this.progress.setAttribute("min","0"),this.progress.setAttribute("max","1000"),this.progress.setAttribute("step","1"),this.progress.setAttribute("class","swmp swmp-progress"),this.seekContain.appendChild(this.progress),this.seeker=document.createElement("input"),this.seeker.setAttribute("type","range"),this.seeker.setAttribute("value","0"),this.seeker.setAttribute("min","0"),this.seeker.setAttribute("max","1000"),this.seeker.setAttribute("step","1"),this.seeker.setAttribute("class","swmp swmp-seeker"),this.seekContain.appendChild(this.seeker),this.bottomRow=document.createElement("span"),this.bottomRow.setAttribute("class","swmp swmp-row-bottom"),this.controls.appendChild(this.bottomRow),this.buttonsContain=document.createElement("span"),this.buttonsContain.setAttribute("class","swmp swmp-buttons-container"),this.bottomRow.appendChild(this.buttonsContain),this.playbutton=document.createElement("button"),this.playbutton.setAttribute("class","swmp swmp-button swmp-playbutton"),this.playbutton.innerHTML="<span></span>",this.playbutton.addEventListener("click",(e=>{e.preventDefault(),this.player.paused?this.player.play():this.player.pause()})),this.buttonsContain.appendChild(this.playbutton),this.stopbutton=document.createElement("button"),this.stopbutton.setAttribute("class","swmp swmp-button swmp-stopbutton"),this.stopbutton.innerHTML="<span></span>",this.stopbutton.addEventListener("click",(e=>{e.preventDefault(),this.player.pause(),this.seeker.value=0,this.seeker.setAttribute("value",0),this.progress.value=0,this.progress.setAttribute("value",0),this.player.currentTime=0,this.currentTimer.textContent="00:00"})),this.buttonsContain.appendChild(this.stopbutton),this.volumeContain=document.createElement("span"),this.volumeContain.setAttribute("class","swmp swmp-volume-container"),this.bottomRow.appendChild(this.volumeContain),this.volumeButton=document.createElement("button"),this.volumeButton.setAttribute("class","swmp swmp-button swmp-volume"),this.volumeButton.innerHTML="<span></span>",this.volumeButton.addEventListener("click",(e=>{e.preventDefault(),this.toggleMute()})),this.buttonsContain.appendChild(this.volumeButton),this.volumeProgress=document.createElement("progress"),this.volumeProgress.setAttribute("value",this.defaultVolume),this.volumeProgress.setAttribute("min","0"),this.volumeProgress.setAttribute("max","100"),this.volumeProgress.setAttribute("step","1"),this.volumeProgress.setAttribute("class","swmp swmp-volume swmp-progress"),this.volumeContain.appendChild(this.volumeProgress),this.volumeRange=document.createElement("input"),this.volumeRange.setAttribute("type","range"),this.volumeRange.setAttribute("value",this.defaultVolume),this.volumeRange.setAttribute("min","0"),this.volumeRange.setAttribute("max","100"),this.volumeRange.setAttribute("step","1"),this.volumeRange.setAttribute("class","swmp swmp-volume swmp-range"),this.volumeContain.appendChild(this.volumeRange),this.timerContain=document.createElement("span"),this.timerContain.setAttribute("class","swmp swmp-timer-container"),this.bottomRow.appendChild(this.timerContain),this.currentTimer=document.createElement("span"),this.currentTimer.setAttribute("class","swmp swmp-time swmp-current"),this.currentTimer.textContent="00:00",this.timerContain.appendChild(this.currentTimer),this.timerSeperator=document.createElement("span"),this.timerSeperator.setAttribute("class","swmp swmp-time swmp-separator"),this.timerSeperator.textContent="/",this.timerContain.appendChild(this.timerSeperator),this.totalTimer=document.createElement("span"),this.totalTimer.setAttribute("class","swmp swmp-time swmp-total"),this.totalTimer.textContent="00:00",this.timerContain.appendChild(this.totalTimer),"video"==this.type&&(this.fullscreenbutton=document.createElement("button"),this.fullscreenbutton.setAttribute("class","swmp swmp-button swmp-fullscreen"),this.fullscreenbutton.innerHTML="<span></span>",this.fullscreenbutton.addEventListener("click",(e=>{e.preventDefault(),this.fullscreen(this.container)})),this.bottomRow.appendChild(this.fullscreenbutton)),this.playerContainer.addEventListener("click",(e=>{this.togglePlay()})),this.playerContainer.addEventListener("dblclick",(e=>{this.fullscreen(this.container)})),this.container.addEventListener("keydown",(e=>{if(!e.repeat){switch(e.key){case" ":this.togglePlay();break;case"f":this.fullscreen(this.container);break;case"m":this.toggleMute();break;case"x":this.container.remove();break;default:return}e.preventDefault()}}),!0),this.player.onended=e=>{this.player.classList.remove("swmp-playing"),this.playbutton.classList.remove("swmp-playing"),this.seeker.value=0,this.progress.value=0,clearInterval(this.player.interval),this.currentTimer.textContent="00:00"},this.player.addEventListener("loadedmetadata",(e=>{this.totalTimer.textContent=this.formatSeconds(this.player.duration)})),this.player.onplay=e=>{this.player.classList.add("swmp-playing"),this.playbutton.classList.add("swmp-playing");var t=this;this.player.interval=window.setInterval((function(e){t.player.timeupdate()}),40)},this.player.onpause=e=>{this.player.classList.remove("swmp-playing"),this.playbutton.classList.remove("swmp-playing"),clearInterval(this.player.interval)},this.player.onerror=e=>{clearInterval(this.player.interval);var t=this.player.error.message;this.container.innerHTMl=t},this.player.timeupdate=e=>{this.seeker.value=Math.floor(this.player.currentTime/this.player.duration*this.seeker.max),this.seeker.setAttribute("value",this.seeker.value),this.progress.value=this.seeker.value,this.progress.setAttribute("value",this.seeker.value),this.updateTimer()},this.seeker.oninput=e=>{this.player.currentTime=Math.floor(this.player.duration*this.seeker.value/this.seeker.max),this.progress.value=this.seeker.value,this.progress.setAttribute("value",this.seeker.value),this.updateTimer()},this.container.addEventListener("fullscreenchange",(e=>{document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?this.container.classList.add("swmp-fullscreen"):this.container.classList.remove("swmp-fullscreen")})),this.formatSeconds=e=>(this._sec_num=parseInt(e,10),this._hours=Math.floor(this._sec_num/3600),this._minutes=Math.floor(this._sec_num/60)%60,this._seconds=this._sec_num%60,[this._hours,this._minutes,this._seconds].map((e=>e<10?"0"+e:e)).filter(((e,t)=>"00"!==e||t>0)).join(":")),this.updateTimer=()=>{this.currentTimer.textContent=this.formatSeconds(this.player.currentTime)},this.fullscreen=e=>{document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?(document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen(),this.container.classList.remove("swmp-fullscreen")):(e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen(),this.container.classList.add("swmp-fullscreen"))},this.toggleMute=()=>{this.player.muted?(this.volumeButton.classList.remove("swmp-mute"),this.player.muted=!1,this._volume=Math.floor(100*this.player.volume),this.volumeRange.setAttribute("value",this._volume),this.volumeRange.value=this._volume,this.volumeProgress.setAttribute("value",this._volume),this.volumeProgress.value=this._volume):(this.volumeButton.classList.add("swmp-mute"),this.player.muted=!0,this.volumeRange.setAttribute("value",0),this.volumeRange.value=0,this.volumeProgress.setAttribute("value",0),this.volumeProgress.value=0)},this.togglePlay=()=>{this.player.paused?this.player.play():this.player.pause()},this.updateVolume=(e=!1)=>{this.volumeButton.classList.remove("swmp-mute"),1==e&&(this.volumeRange.setAttribute("value",this.defaultVolume),this.volumeProgress.setAttribute("value",this.defaultVolume),this.playerVolume=this.defaultVolume,this.volumeButton.classList.add("swmp-min")),this.player.muted&&(this.player.muted=!1),this.volumeRange.setAttribute("value",this.volumeRange.value),this.volumeProgress.setAttribute("value",this.volumeRange.value),this.player.volume=parseFloat(this.volumeRange.value/100),this.player.volume>.5?(this.volumeButton.classList.add("swmp-max"),this.volumeButton.classList.remove("swmp-med"),this.volumeButton.classList.remove("swmp-min")):this.player.volume>.1?(this.volumeButton.classList.add("swmp-med"),this.volumeButton.classList.remove("swmp-max"),this.volumeButton.classList.remove("swmp-min")):this.player.volume>.05&&(this.volumeButton.classList.add("swmp-min"),this.volumeButton.classList.remove("swmp-max"),this.volumeButton.classList.remove("swmp-med")),localStorage.swmpVolume=this.volumeRange.value,swmpConfig.volume=this.volumeRange.value},this.volumeRange.oninput=e=>{this.updateVolume()},this.player.addEventListener("volumechange",this.updateVolume()),this.updateVolume(!0),this.openSettings=()=>{if(null!=this.container.querySelector(".swmp-settings-container"))return this.settingsContainer.remove(),!1;this.settingsContainer=document.createElement("div"),this.settingsContainer.setAttribute("class","swmp swmp-settings swmp-settings-container"),this.settingsContainer.innerHTML="Settings:",this.container.appendChild(this.settingsContainer),this.br=document.createElement("br"),this.settingsContainer.appendChild(this.br),this.themeSelector=document.createElement("select"),this.themeSelector.setAttribute("class","swmp swmp-selector swmp-settings swmp-theme-selector"),this.themes="",swmpConfig.themes.forEach((e=>{localStorage.swmpTheme==e[0]?(this.themeSelector.value=e[0],this.themes+=`<option value="${e[0]}" selected>${e[1]}</option>`):this.themes+=`<option value="${e[0]}">${e[1]}</option>`})),this.themeSelector.innerHTML=this.themes,this.themeSelector.onchange=e=>{if(""==this.themeSelector.value)return!1;this.removeClassByPrefix(this.container,"swmp-theme-"),this.container.classList.add(`swmp-theme-${this.themeSelector.value}`),swmpConfig.theme=this.themeSelector.value,localStorage.swmpTheme=this.themeSelector.value},this.settingsContainer.appendChild(this.themeSelector),this.autoplayLabel=document.createElement("label"),this.autoplayLabel.setAttribute("class","swmp swmp-settings swmp-label swmp-autoplay-label"),this.autoplayLabel.textContent="Autoplay",this.autoplayCheck=document.createElement("input"),this.autoplayCheck.setAttribute("class","swmp swmp-settings swmp-input swmp-autoplay-input"),this.autoplayCheck.setAttribute("type","checkbox"),"true"==localStorage.swmpAutoplay&&this.autoplayCheck.setAttribute("checked","checked"),this.autoplayCheck.addEventListener("change",(e=>{1==this.autoplayCheck.checked?(this.autoplayCheck.setAttribute("checked","checked"),localStorage.swmpAutoplay="true",swmpConfig.autoplay="true"):(this.autoplayCheck.removeAttribute("checked"),localStorage.swmpAutoplay="false",swmpConfig.autoplay="false")})),this.autoplayLabel.appendChild(this.autoplayCheck),this.settingsContainer.appendChild(this.autoplayLabel),this.loopLabel=document.createElement("label"),this.loopLabel.setAttribute("class","swmp swmp-settings swmp-label swmp-loop-label"),this.loopLabel.textContent="Loop",this.loopCheck=document.createElement("input"),this.loopCheck.setAttribute("class","swmp swmp-settings swmp-input swmp-loop-input"),this.loopCheck.setAttribute("type","checkbox"),"true"==localStorage.swmpLoop&&this.loopCheck.setAttribute("checked","checked"),this.loopCheck.addEventListener("change",(e=>{1==this.loopCheck.checked?(this.loopCheck.setAttribute("checked","checked"),this.player.setAttribute("loop","true"),localStorage.swmpLoop="true",swmpConfig.loop="true"):(this.loopCheck.removeAttribute("checked"),this.player.removeAttribute("loop"),localStorage.swmpLoop="false",swmpConfig.loop="false")})),this.loopLabel.appendChild(this.loopCheck),this.settingsContainer.appendChild(this.loopLabel),this.multiLabel=document.createElement("label"),this.multiLabel.setAttribute("class","swmp swmp-settings swmp-label swmp-multi-label"),this.multiLabel.textContent="Multi",this.multiCheck=document.createElement("input"),this.multiCheck.setAttribute("class","swmp swmp-settings swmp-input swmp-multi-input"),this.multiCheck.setAttribute("type","checkbox"),"true"==localStorage.swmpAllowMultiple&&this.multiCheck.setAttribute("checked","checked"),this.multiCheck.addEventListener("change",(e=>{1==this.multiCheck.checked?(this.multiCheck.setAttribute("checked","checked"),localStorage.swmpAllowMultiple="true",swmpConfig.allowMultiple="true"):(this.multiCheck.removeAttribute("checked"),localStorage.swmpAllowMultiple="false",swmpConfig.allowMultiple="false")})),this.multiLabel.appendChild(this.multiCheck),this.settingsContainer.appendChild(this.multiLabel)}}removeClassByPrefix(e,t){var s=new RegExp("("+t+"(\\s|(-)?(\\w*)(\\s)?)).*?","g");e.className=e.className.replace(s,"")}uuid(){var e=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var s=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"==t?s:3&s|8).toString(16)}))}getFileName(e){return e.split("/").pop().split("#")[0].split("?")[0]}checkURL(e){switch(this.fileExt=e.split(/[#?&]/)[0].split(".").pop().trim(),this.fileExt=e.split(/[#?&]/).slice(-2)[0].split(".").pop().trim(),console.log(this.fileExt),this.fileExt=this.fileExt.toLowerCase(),this.fileExt){case"avi":this.type="video",this.mime="video/x-msvideo";break;case"mpeg":case"mpg":this.type="video",this.mime="video/mpeg";break;case"ogv":this.type="video",this.mime="video/ogg";break;case"mp4":this.type="video",this.mime="video/mp4";break;case"webm":this.type="video",this.mime="video/webm";break;case"flv":this.type="video",this.mime="video/x-flv";break;case"wav":this.type="audio",this.mime="audio/x-wav";break;case"mp3":case"mp2":this.type="audio",this.mime="audio/mpeg";break;case"m4a":this.type="audio",this.mime="audio/mp4";break;case"ogg":this.type="audio",this.mime="audio/ogg";break;case"flac":this.type="audio",this.mime="audio/flac";break;default:return console.log("No matching ext/mime"),console.log(this.fileExt),!1}return!0}makeDraggable(e){var t=this.windowTitlebar;e.style.position="fixed",e.style.top=swmpConfig.positionTop+"px","right"==swmpConfig.positionSide?e.style.right=swmpConfig.positionOffset+"px":e.style.left=swmpConfig.positionOffset+"px";var s,i,o,r,n,a,p,l,m,u,h=!1;document.addEventListener("mousemove",(function(t){if(h){"1"!=t.which&&(h=!1);var s=t.clientX,i=t.clientY;a=i-l,p=s-n,m=document.documentElement.clientWidth-e.offsetWidth,u=window.innerHeight-e.offsetHeight,(p<0||a<0||p>m||a>u)&&(p<0&&(p=0),a<0&&(a=0),p>m&&(p=m),a>u&&(a=u)),e.style.top=a+"px","right"==swmpConfig.positionSide?(e.style.left=p+"px",e.style.right="unset"):e.style.left=p+"px"}})),t.addEventListener("mouseup",(function(){if(h=!1,"right"==swmpConfig.positionSide){var t=parseInt(e.style.left,10);e.style.left="unset",e.style.right=document.documentElement.clientWidth-t-e.offsetWidth+"px"}})),t.addEventListener("mousedown",(function(t){if("3"==t.which)return!1;h=!0,s=t.clientX,i=t.clientY,o=e.offsetTop,r=e.offsetLeft,n=s-r,l=i-o}))}}document.querySelector("body").addEventListener("click",(e=>{if("A"!=e.target.tagName&&"A"!=e.target.parentNode.tagName)return;var t=!1;function s(e){if("fourchan"==backendScript)return e.parentNode.querySelector("div.fileText a").getAttribute("title")?e.parentNode.querySelector("div.fileText a").getAttribute("title"):e.parentNode.querySelector("div.fileText a").innerText;if("vichan"==backendScript){let s=new RegExp(`([^/|^=|^\n|^&])+.(${swmpConfig.files})([^w]|$)`,"gi");var t=e.match(s);return t.forEach((e=>function(e){return e=e.replace("/(?|&)+/i","")})),t.slice(-1)[0]}}"A"==e.target.tagName?t=e.target:"A"==e.target.parentNode.tagName?t=e.target.parentNode:"A"==e.target.parentNode.parentNode.tagName&&(t=e.target.parentNode.parentNode);var i,o=function(){if(""==backendScript||null==backendScript||null==backendScript||"fourchan"==backendScript)return t.getAttribute("href");if("vichan"==backendScript){var e=t.parentNode.querySelectorAll("p.fileinfo a"),s="";let o=new RegExp(".("+swmpConfig.files+")+$","i");for(var i=0;i<e.length;i++)e[i].getAttribute("href").match(o)&&(s=e[i]);return""==s&&(s=t),s.getAttribute("href")}return t.getAttribute("href")}(),r=(i=t.getAttribute("href"),""==backendScript||null==backendScript||null==backendScript||"fourchan"==backendScript||backendScript,i),n=!1;n=""==backendScript||null==backendScript||null==backendScript?decodeURI(r):"fourchan"==backendScript?decodeURI(s(t)):"vichan"==backendScript?decodeURI(s(t.getAttribute("href"))):decodeURI(r),console.log("URL: "+t.getAttribute("href")),console.log("Filename: "+r);let a=new RegExp(`.(${swmpConfig.files})+$`,"gi");if(!o.match(a))return!1;console.log(o+": matched video or audio"),e.preventDefault(),e.stopPropagation();var p=!1;if(p="false"!=swmpConfig.allowMultiple?`play-swmp-${t.getAttribute("href")}`:"play-swmp",void 0!==document.getElementById(p)&&null!=document.getElementById(p)){if("false"!=swmpConfig.allowMultiple)return!1;document.getElementById(p).remove()}console.log(p+o+n);let l=new swmp({id:p,url:o,title:n});console.log(backendScript),"jschan"==backendScript?t.parentNode.parentNode.appendChild(l.container):t.parentNode.appendChild(l.container)}),!0);